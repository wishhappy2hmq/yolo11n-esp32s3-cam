# 项目部署指南

## 概述
本指南说明了哪些文件会被包含在构建中，哪些可以删除，以及如何复制项目的工作版本。

---

## 项目结构分析

### 构建中包含的文件

ESP-IDF 构建系统**仅编译 CMakeLists.txt 中引用的文件**。根据配置：

#### 根目录层级
```
yolo11_detect/
├── CMakeLists.txt              ✓ 必需 - 主项目文件
├── partitions.csv              ✓ 必需 - Flash 分区表
├── sdkconfig.defaults          ✓ 必需 - 基础配置
├── sdkconfig.defaults.esp32s3  ✓ 必需 - ESP32-S3 特定配置
├── sdkconfig.camera.esp32s3    ✓ 可选 - 摄像头配置
├── main/                       ✓ 必需 - 应用程序代码
│   ├── CMakeLists.txt
│   ├── idf_component.yml
│   └── app_main.cpp
├── coco_detect/                ✓ 必需 - YOLO 检测组件
│   ├── CMakeLists.txt
│   ├── Kconfig
│   ├── idf_component.yml
│   ├── coco_detect.cpp
│   ├── coco_detect.hpp
│   └── models/s3/*.espdl       ✓ 模型文件（仅选定的模型）
└── esp-dl/                     ✓ 必需 - ESP-DL 库
    ├── CMakeLists.txt
    ├── dl/                     ✓ 核心深度学习库
    ├── vision/                 ✓ 视觉算法
    ├── audio/                  ✓ 音频功能
    └── fbs_loader/             ✓ 模型加载器
```

#### 托管组件（自动下载）
```
managed_components/             ✓ ESP-IDF 自动管理
├── espressif__button/
├── espressif__esp32-camera/
├── espressif__esp32_s3_eye_noglib/
├── espressif__esp_codec_dev/
├── espressif__esp_jpeg/
├── espressif__esp_new_jpeg/
└── espressif__esp-dsp/
```

---

### 构建中排除的文件

以下目录**不会被编译**，可以安全删除：

#### 文档文件
```
❌ 可删除：
├── README.md                   # 文档
├── BUILD_GUIDE.md              # 构建说明
├── LICENSE                     # 许可证文件
├── *.md                        # 所有 markdown 文件
└── img/                        # 文档图片
```

#### 示例项目
```
❌ 可删除 - 示例（34+ 个目录）：
├── esp-dl/examples/            # ESP-DL 示例
│   ├── basic_math/
│   ├── conv2d/
│   ├── dotprod/
│   ├── fft/
│   ├── fft4real/
│   ├── fir/
│   ├── iir/
│   ├── kalman/
│   └── matrix/
├── esp-dl/applications/        # ESP-DL 应用示例
│   ├── lyrat_board_app/
│   ├── spectrum_box_lite/
│   └── m5stack_core_s3/
└── esp-dl/external_examples/   # 外部示例
```

```
❌ 可删除 - 托管组件示例：
├── managed_components/espressif__esp32-camera/examples/
├── managed_components/espressif__esp_jpeg/examples/
├── managed_components/espressif__esp_jpeg/test_apps/
├── managed_components/espressif__esp-dsp/examples/
├── managed_components/espressif__esp-dsp/applications/
├── managed_components/espressif__esp-dsp/external_examples/
├── managed_components/espressif__button/examples/
└── managed_components/espressif__button/test_apps/
```

#### 测试文件
```
❌ 可删除 - 测试：
├── esp-dl/test/                # 单元测试
└── managed_components/**/test/ # 组件测试
```

---

## 部署所需的核心文件

### 最小工作项目

要创建可部署版本，您需要：

```
yolo11_detect_minimal/
├── CMakeLists.txt
├── partitions.csv
├── sdkconfig.defaults
├── sdkconfig.defaults.esp32s3
├── main/
│   ├── CMakeLists.txt
│   ├── idf_component.yml
│   └── app_main.cpp
├── coco_detect/
│   ├── CMakeLists.txt
│   ├── Kconfig
│   ├── idf_component.yml
│   ├── coco_detect.cpp
│   ├── coco_detect.hpp
│   └── models/
│       └── s3/
│           └── mymodel.espdl          # 仅您正在使用的模型
└── esp-dl/
    ├── CMakeLists.txt
    ├── idf_component.yml
    ├── dl/                             # 核心库源码
    ├── vision/                         # 视觉算法
    ├── audio/                          # 音频功能
    └── fbs_loader/                     # 模型加载器
```

**注意**：运行 `idf.py build` 时，`managed_components/` 将自动下载

## 编译内容

### 构建过程中

1. **CMake 扫描**：
   - 根目录 `CMakeLists.txt`
   - 组件 `CMakeLists.txt`（main、coco_detect、esp-dl）
   - 依赖 `idf_component.yml` 文件

2. **编译的源文件**：
   - `main/app_main.cpp`
   - `coco_detect/*.cpp`
   - `esp-dl/dl/**/*.c` 和 `esp-dl/dl/**/*.cpp`
   - `esp-dl/vision/**/*.c`
   - `esp-dl/audio/**/*.c`
   - 托管组件源码（自动下载）

3. **嵌入的数据**：
   - `coco_detect/models/s3/mymodel.espdl`（仅选定的模型）

4. **不编译**：
   - `examples/` 目录中的任何文件
   - `test/` 或 `test_apps/` 目录中的任何文件
   - Markdown 文件（*.md）
   - 文档图片

---

## 依赖管理

### 组件依赖

**主应用程序**（`main/idf_component.yml`）：
```yaml
dependencies:
  espressif/coco_detect: "*"              # 本地覆盖
  espressif/esp32-camera: "^2.0.0"        # 自动下载
  espressif/esp32_s3_eye_noglib: "^3.1.0~1"  # 自动下载
```

**COCO 检测**（`coco_detect/idf_component.yml`）：
```yaml
dependencies:
  espressif/esp-dl: "~3.2.0"              # 本地覆盖
```

### 托管组件

这些在构建期间**自动下载**：
- `espressif__button`
- `espressif__cmake_utilities`
- `espressif__dl_fft`
- `espressif__esp-dsp`
- `espressif__esp32-camera`
- `espressif__esp_codec_dev`
- `espressif__esp_jpeg`
- `espressif__esp_new_jpeg`

**重要**：您可以删除 `managed_components/` 文件夹。它将在下次构建时自动重新创建。

---

## 部署复制检查清单

### 复制前
- [ ] 验证项目构建成功
- [ ] 在硬件上测试以确认功能
- [ ] 记录您正在使用的模型（`mymodel.espdl`）
- [ ] 识别任何自定义修改

### 必须复制的核心文件
- [ ] 根目录 CMakeLists.txt
- [ ] partitions.csv
- [ ] sdkconfig.defaults*
- [ ] main/ 文件夹（完整）
- [ ] coco_detect/ 文件夹（至少包含一个模型）
- [ ] esp-dl/ 文件夹（源代码，无示例）

### 可选复制
- [ ] README.md（如果需要文档）
- [ ] BUILD_GUIDE.md
- [ ] 模型文档
- [ ] 额外的模型文件（.espdl）

### 复制后
- [ ] 删除 `build/` 文件夹
- [ ] 删除 `managed_components/` 文件夹
- [ ] 删除 `sdkconfig` 和 `sdkconfig.old`
- [ ] 运行 `idf.py set-target esp32s3`
- [ ] 运行 `idf.py build`
- [ ] 验证构建成功

---

## 快速参考

### 必须复制的文件
```
✓ CMakeLists.txt（根目录）
✓ partitions.csv
✓ sdkconfig.defaults*
✓ main/（所有文件）
✓ coco_detect/（源码 + 至少 1 个模型）
✓ esp-dl/（仅源码，无示例）
```

### 可以删除的文件
```
❌ */examples/
❌ */test/
❌ */test_apps/
❌ *.md（关键文档除外）
❌ img/
❌ managed_components/（自动重新生成）
❌ build/（构建产物）
```

### 重新构建命令
```bash
# 清理所有内容
idf.py fullclean
rm -rf build managed_components sdkconfig*

# 从头重新构建
idf.py set-target esp32s3
idf.py build
```

---

## 故障排除

### 缺少依赖
- **问题**：构建失败，提示"找不到组件"
- **解决方案**：删除 `managed_components/` 和 `dependencies.lock`，然后重新构建

### 找不到模型
- **问题**：构建失败，提示"找不到模型文件"
- **解决方案**：确保选定的模型存在于 `coco_detect/models/s3/`

### 权限错误（Windows）
- **问题**：无法复制文件
- **解决方案**：使用 robocopy 或以管理员权限运行 PowerShell

### 大小过大
- **问题**：部署副本仍然很大
- **解决方案**：复制前运行 `idf.py fullclean`，删除 `build/` 文件夹
