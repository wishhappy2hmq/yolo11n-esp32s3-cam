# YOLO11 模型替换指南

## 概述
本指南说明如何替换 ESP32-S3 项目中的 YOLO11 检测模型。

---

## 模型配置文件

### 需要修改的关键文件

1. **模型文件位置**
   - 路径：`coco_detect/models/s3/mymodel.espdl`
   - 这是启用 `CONFIG_FLASH_COCO_DETECT_MYMODEL` 时使用的实际模型文件

2. **Kconfig 配置**
   - 路径：`coco_detect/Kconfig`
   - 定义可用模型及其选择选项

3. **CMake 构建配置**
   - 路径：`coco_detect/CMakeLists.txt`
   - 处理模型打包和烧录

4. **SDK 配置**
   - 路径：`sdkconfig.defaults.esp32s3`
   - 模型选择的默认配置

---

## 替换模型的步骤

### 方法 1：替换当前模型（推荐用于快速更新）

**步骤 1：准备您的模型**
- 确保您的新模型为 `.espdl` 格式
- 模型应量化为 INT8 以适配 ESP32-S3
- 推荐输入大小：320x320 或 192x192

**步骤 2：替换模型文件**
```bash
# 备份原始模型
cp coco_detect/models/s3/mymodel.espdl coco_detect/models/s3/mymodel.espdl.bak

# 复制您的新模型
cp /path/to/your/new_model.espdl coco_detect/models/s3/mymodel.espdl
```

**步骤 3：清理并重新构建**
```bash
idf.py fullclean
idf.py build
```

---

### 方法 2：添加新的模型配置

**步骤 1：添加模型文件**
```bash
# 将您的模型复制到 s3 模型目录
cp /path/to/your/custom_model.espdl coco_detect/models/s3/coco_detect_custom.espdl
```

**步骤 2：更新 Kconfig**（`coco_detect/Kconfig`）

添加 flash 选项（约在第 18 行）：
```kconfig
config FLASH_COCO_DETECT_CUSTOM
    bool "flash custom_model"
    depends on !COCO_DETECT_MODEL_IN_SDCARD
    default n
```

添加选择选项（约在第 40 行）：
```kconfig
config COCO_DETECT_CUSTOM
    bool "custom_model"
    depends on COCO_DETECT_MODEL_IN_SDCARD || FLASH_COCO_DETECT_CUSTOM
```

更新默认模型索引（约在第 51 行）：
```kconfig
config DEFAULT_COCO_DETECT_MODEL
    int
    default 0 if COCO_DETECT_YOLO11N_S8_V1
    default 1 if COCO_DETECT_YOLO11N_S8_V2
    default 2 if COCO_DETECT_YOLO11N_S8_V3
    default 3 if COCO_DETECT_YOLO11N_320_S8_V3
    default 4 if COCO_DETECT_MYMODEL
    default 5 if COCO_DETECT_CUSTOM        # 添加此行
```

**步骤 3：更新 CMakeLists.txt**（`coco_detect/CMakeLists.txt`）

在第 42 行附近添加：
```cmake
if(CONFIG_FLASH_COCO_DETECT_CUSTOM)
    list(APPEND models ${models_dir}/coco_detect_custom.espdl)
endif()
```

**步骤 4：配置并构建**
```bash
idf.py menuconfig
# 导航到：Component config -> models: coco_detect
# 启用 "flash custom_model"
# 选择 "custom_model" 作为默认模型

idf.py build
```

---

## 模型存储选项

### 1. Flash RODATA（默认 - 推荐）
- **位置**：编译到固件中作为只读数据
- **配置**：`CONFIG_COCO_DETECT_MODEL_IN_FLASH_RODATA=y`
- **优点**：访问速度最快，无需外部存储
- **缺点**：占用 flash 空间（每个模型 2-3MB）
- **最大模型数**：受 flash 大小限制（总共 8MB）

### 2. Flash 分区
- **位置**：单独的 flash 分区
- **配置**：`CONFIG_COCO_DETECT_MODEL_IN_FLASH_PARTITION=y`
- **优点**：更新模型更容易，无需重新烧录固件
- **缺点**：需要修改分区表
- **注意**：需要更新 `partitions.csv` 以添加 `coco_det` 分区

### 3. SD 卡
- **位置**：外部 SD 卡
- **配置**：`CONFIG_COCO_DETECT_MODEL_IN_SDCARD=y`
- **优点**：易于切换模型，存储空间无限
- **缺点**：访问速度较慢，需要 SD 卡硬件
- **路径**：通过 `CONFIG_COCO_DETECT_MODEL_SDCARD_DIR` 设置

---

## 可用的预构建模型

项目包含 5 个预构建的 YOLO11n 模型：

| 模型名称 | 文件大小 | 输入大小 | 描述 |
|---------|---------|---------|------|
| yolo11n_s8_v1 | ~2.8 MB | 192x192 | 版本 1（INT8）|
| yolo11n_s8_v2 | ~2.9 MB | 192x192 | 版本 2（INT8）|
| yolo11n_s8_v3 | ~2.8 MB | 192x192 | 版本 3（INT8）|
| yolo11n_320_s8_v3 | ~2.8 MB | 320x320 | 版本 3（320px，INT8）|
| mymodel | ~2.8 MB | 自定义 | 您的自定义模型 |

---

## 模型格式要求

### ESP-DL 模型格式（.espdl）

您的模型必须转换为 ESP-DL 的 `.espdl` 格式：

1. **训练**：使用 PyTorch/Ultralytics 训练您的 YOLO11 模型
2. **导出**：导出为 ONNX 格式
3. **量化**：使用 ESP-DL 工具量化为 INT8
4. **转换**：使用 ESP-DL 的模型转换器转换为 `.espdl` 格式

**参考资料**：
- ESP-DL 模型库：https://github.com/espressif/esp-dl
- 模型转换工具：`esp-dl/tools/`

---

## 替换后的验证

1. **检查构建输出**
   ```bash
   idf.py build
   # 查找输出中的："Move and Pack models..."
   # 验证构建日志中的模型大小
   ```

2. **检查 Flash 大小**
   ```bash
   # 确保您的模型适合分区
   # 检查：build/yolo11_detect.bin 大小 < 8MB
   ```

3. **测试检测**
   - 烧录到设备：`idf.py flash monitor`
   - 检查 HTTP 端点：`http://<设备IP>/`
   - 验证检测结果是否与您的模型类别匹配

---

## 故障排除

### 模型过大
- **问题**：`region 'irom0_0_seg' overflowed`
- **解决方案**：
  - 减小模型大小或使用 Flash 分区/SD 卡存储
  - 在 `sdkconfig.defaults.esp32s3` 中增加 flash 大小：
    ```
    CONFIG_ESPTOOLPY_FLASHSIZE_16MB=y  # 替代 8MB
    ```

### 模型无法加载
- **问题**：设备崩溃或检测失败
- **解决方案**：
  - 验证 `.espdl` 格式是否正确
  - 检查 PSRAM 是否启用（`CONFIG_SPIRAM=y`）
  - 确保模型输入大小与预处理代码匹配

### 加载了错误的模型
- **问题**：仍在使用旧模型
- **解决方案**：
  ```bash
  idf.py fullclean
  rm -rf build/
  idf.py build
  ```

---

## 模型配置摘要

| 配置项 | 位置 | 用途 |
|-------|------|------|
| 模型二进制文件 | `coco_detect/models/s3/*.espdl` | 实际模型数据 |
| 模型选择 | `coco_detect/Kconfig` | 可用模型选项 |
| 构建集成 | `coco_detect/CMakeLists.txt` | 模型打包逻辑 |
| 默认配置 | `sdkconfig.defaults.esp32s3` | 默认模型选择 |
| 检测代码 | `coco_detect/coco_detect.cpp` | 模型加载与推理 |
| 应用程序代码 | `main/app_main.cpp` | 检测流程 |

---

## 快速参考命令

```bash
# 查看当前模型配置
idf.py menuconfig
# 导航到：Component config -> models: coco_detect

# 清理构建
idf.py fullclean

# 详细输出构建
idf.py -v build

# 烧录并监视
idf.py -p COM3 flash monitor

# 检查模型大小
ls -lh coco_detect/models/s3/*.espdl
```

---

## 注意事项

1. **性能**：320x320 模型比 192x192 提供更好的准确性但推理速度较慢
2. **内存**：每个模型需要约 3MB flash + 推理期间约 2MB RAM
3. **类别**：COCO 数据集有 80 个类别。如果使用自定义类别，请在代码中更新检测标签
4. **多个模型**：您可以烧录多个模型，并通过 menuconfig 在它们之间切换
